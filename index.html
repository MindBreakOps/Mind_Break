<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<title>Mind Break | Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script src="https://unpkg.com/lucide@latest"></script>
	<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
	<style>
		@import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap');
		body { font-family: 'Tajawal', sans-serif; background-color: #F8F5EE; color: #331111; overflow-x: hidden; }
		.glass { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(15px); border: 1px solid white; border-radius: 2rem; }
		.page-content { display: none; padding-bottom: 120px; }
		.active { display: block; animation: slideUp 0.3s ease-out; }
		@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
		.nav-active { background: #632323 !important; color: white !important; }
		.invoice-card { background: white; padding: 20px; border-radius: 1.5rem; border: 1px solid #eee; margin-bottom: 15px; position: relative; }
		input, select { outline: none !important; border: 1px solid #eee !important; transition: all 0.3s; }
		input:focus { border-color: #632323 !important; ring: 2px #632323; }
		.logo-frame { border: 3px solid #632323; padding: 4px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: white; }
	</style>
</head>
<body>

	<section id="login-page" class="fixed inset-0 z-[100] bg-[#F8F5EE] flex items-center justify-center p-6">
		<div class="glass p-10 w-full max-w-sm text-center shadow-2xl border-2 border-[#632323]/5">
			<div class="w-24 h-24 logo-frame mx-auto mb-6 shadow-lg">
				<img src="mind.png" class="w-16 h-16 object-contain" onerror="this.src='https://via.placeholder.com/100?text=MB'">
			</div>
			<h2 class="text-2xl font-black text-[#632323] mb-8 uppercase italic">MIND BREAK</h2>
			<div class="space-y-4">
				<input type="text" id="login-user" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="w-full p-4 rounded-2xl bg-white outline-none text-center">
				<input type="password" id="login-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="w-full p-4 rounded-2xl bg-white outline-none text-center">
				<button onclick="handleLogin()" id="login-btn" class="w-full bg-[#632323] text-white py-4 rounded-2xl font-black text-lg active:scale-95 transition-all">Sign in</button>
			</div>
		</div>
	</section>

	<div id="main-app" class="hidden">
		<header class="p-6 flex justify-between items-center max-w-4xl mx-auto text-right">
			<div class="flex items-center gap-3">
				<div class="w-12 h-12 logo-frame shadow-sm">
					<img src="mind.png" class="w-8 h-8 object-contain">
				</div>
				<div>
					<h1 id="user-display" class="font-black text-[#632323] text-sm tracking-tight"></h1>
					<span id="role-tag" class="text-[9px] bg-[#632323] text-white px-2 py-0.5 rounded-md font-bold uppercase tracking-widest"></span>
				</div>
			</div>
			<button onclick="location.reload()" class="p-3 bg-white rounded-xl shadow-sm text-red-500 hover:bg-red-50 transition-colors"><i data-lucide="power"></i></button>
		</header>

		<main class="max-w-4xl mx-auto px-6">
			<section id="dashboard" class="page-content">
				<div class="flex gap-2 mb-6">
					<button onclick="switchTab('mb')" id="tab-mb" class="flex-1 py-3 rounded-2xl font-bold bg-[#632323] text-white shadow-lg transition-all">Mind Break</button>
					<button onclick="switchTab('external')" id="tab-ext" class="flex-1 py-3 rounded-2xl font-bold bg-white text-[#632323] transition-all">Ø¹Ù…ÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ</button>
				</div>
				<div class="glass p-6 shadow-xl">
					<div id="form-fields" class="space-y-4"></div>
					<button onclick="saveProcess()" id="save-btn" class="w-full bg-[#632323] text-white py-5 rounded-3xl font-black mt-6 shadow-xl active:scale-95 transition-all">Ø¥Ø±Ø³Ø§Ù„ ÙˆØ­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
				</div>
			</section>

			<section id="reports" class="page-content">
				<div class="flex justify-between items-center mb-6">
					<h2 class="text-2xl font-black text-[#632323]">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h2>
					<button onclick="loadReports()" class="p-2 bg-white rounded-full shadow-sm active:rotate-180 transition-all"><i data-lucide="rotate-cw" size="16"></i></button>
				</div>
				<div id="reports-list" class="space-y-4"></div>
			</section>
			<section id="biometric" class="page-content">
				<div class="flex justify-between items-center mb-6">
			<a href="https://mindbreakops.github.io/MBO-HumanResourceSystem/" target="_blank" class="p-4 rounded-[1.5rem] flex items-center justify-center">
				<i data-lucide="fingerprint"></i>
			</a>
				</section>
			<section id="attendance" class="page-content">
				<h2 class="text-2xl font-black text-[#632323] mb-6 text-center">Ø§Ù„ØªØ­Ø¶ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</h2>
				<div id="attendance-list" class="space-y-3"></div>
			</section>
		</main>

		<nav id="nav-bar" class="fixed bottom-8 left-1/2 -translate-x-1/2 w-[92%] max-w-md glass p-2 flex justify-around shadow-2xl z-[90]">
			<button onclick="navTo('dashboard')" id="nav-dashboard" class="p-4 rounded-[1.5rem]"><i data-lucide="plus-square"></i></button>
			<button onclick="navTo('reports')" id="nav-reports" class="p-4 rounded-[1.5rem]"><i data-lucide="clipboard-list"></i></button>
			<button onclick="navTo('attendance')" id="nav-attendance" class="p-4 rounded-[1.5rem] hidden"><i data-lucide="users"></i></button>
		</nav>
	</div>

	<div id="receipt-capture" class="fixed -left-[5000px] bg-white p-10 w-[400px] text-center border-4 border-[#632323]">
		<div class="w-24 h-24 logo-frame mx-auto mb-6">
			<img src="mind.png" class="w-16 h-16">
		</div>
		<h2 class="font-black text-3xl text-[#632323] border-b-2 border-dashed pb-6 mb-6 uppercase italic">MIND BREAK</h2>
		<div id="cap-data" class="space-y-6 text-2xl text-right font-bold"></div>
		<div id="staff-contact" class="mt-8 pt-4 border-t border-dashed text-right">
			<p class="text-sm opacity-60">Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</p>
			<p id="cap-staff-name" class="font-black text-lg text-[#632323]"></p>
			<p id="cap-staff-phone" class="font-bold text-md"></p>
		</div>
		<div class="mt-8 text-[10px] opacity-40 italic">Generated by Mind Break OS</div>
	</div>

	<script>
		const API_URL = 'https://script.google.com/macros/s/AKfycbxBgJQTQHEsQgmXpe0UmJ18MFgoyuKpwrCayzN65JaC_NasKeDCNDDTHwIcEIb9KJPO/exec';
		let currentUser = null;
		let currentMode = 'mb';

		async function handleLogin() {
			const user = document.getElementById('login-user').value.trim();
			const pass = document.getElementById('login-pass').value.trim();
			const btn = document.getElementById('login-btn');
			if(!user || !pass) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
			btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚..."; btn.disabled = true;
			try {
				const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'login', user, pass }) });
				const result = await res.json();
				if(result.status === "success") { currentUser = result; setupUI(); } else { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); }
			} catch(e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„"); }
			btn.innerText = "Sign in"; btn.disabled = false;
		}

		function setupUI() {
			document.getElementById('login-page').classList.add('hidden');
			document.getElementById('main-app').classList.remove('hidden');
			document.getElementById('user-display').innerText = `Ø£Ù‡Ù„Ø§Ù‹ØŒ ${currentUser.name}`;
			document.getElementById('role-tag').innerText = currentUser.role;
			if(currentUser.role === 'Admin') document.getElementById('nav-attendance').classList.remove('hidden');
			navTo('dashboard');
		}

		function switchTab(mode) {
			currentMode = mode;
			const container = document.getElementById('form-fields');
			document.getElementById('tab-mb').className = mode==='mb' ? "flex-1 py-3 rounded-2xl font-bold bg-[#632323] text-white shadow-lg" : "flex-1 py-3 rounded-2xl font-bold bg-white text-[#632323]";
			document.getElementById('tab-ext').className = mode==='external' ? "flex-1 py-3 rounded-2xl font-bold bg-[#632323] text-white shadow-lg" : "flex-1 py-3 rounded-2xl font-bold bg-white text-[#632323]";
			if(mode === 'mb') {
				container.innerHTML = `<input type="text" id="plateNum" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø© (Ø£ Ø¨ Ø¬ 123)" class="w-full p-5 rounded-2xl bg-white font-bold uppercase text-center shadow-inner"><input type="number" id="cardNum" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙƒØ±Øª" class="w-full p-5 rounded-2xl bg-white font-bold text-center"><div class="p-4 bg-green-50 text-green-700 rounded-2xl text-center font-black italic text-sm">MIND BREAK CLIENT (FREE)</div>`;
			} else {
				container.innerHTML = `<input type="text" id="clientName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" class="w-full p-4 rounded-2xl bg-white font-bold"><input type="text" id="plateNum" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©" class="w-full p-4 rounded-2xl bg-white font-bold uppercase text-center"><input type="number" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„" class="w-full p-4 rounded-2xl bg-white font-bold"><input type="number" id="cardNum" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙƒØ±Øª" class="w-full p-4 rounded-2xl bg-white font-bold text-center"><div class="flex justify-between p-4 bg-[#632323]/5 rounded-2xl font-bold"><span>Ø±Ø³ÙˆÙ… Ø§Ù„Ø®Ø¯Ù…Ø©:</span><span>25.00 Ø±ÙŠØ§Ù„</span></div>`;
			}
		}

		async function saveProcess() {
			const plate = document.getElementById('plateNum').value;
			const card = document.getElementById('cardNum').value;
			if(!plate || !card) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");
			const data = {
				action: 'saveInvoice', plateNum: plate, cardNum: card, valetName: currentUser.name,
				serviceType: currentMode === 'mb' ? 'Free' : 'Paid', amount: currentMode === 'mb' ? 0 : 25,
				clientName: currentMode === 'external' ? document.getElementById('clientName').value : 'Ø¹Ø¶Ùˆ Mind Break',
				phone: currentMode === 'external' ? document.getElementById('phone').value : '-'
			};
			const btn = document.getElementById('save-btn');
			btn.disabled = true; btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";
			try {
				await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
				// Ø¥ØµØ¯Ø§Ø± Ø¥ÙŠØµØ§Ù„ ÙÙˆØ±ÙŠ Ù„Ù„Ù…ÙˆØ¸Ù Ù„Ù…Ø´Ø§Ø±ÙƒØªÙ‡
				await captureAndDownload(data);
				alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙˆØ¥ØµØ¯Ø§Ø± Ø§Ù„Ø¥ÙŠØµØ§Ù„!");
				switchTab(currentMode);
			} catch(e) { alert("ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); }
			btn.disabled = false; btn.innerText = "Ø¥Ø±Ø³Ø§Ù„ ÙˆØ­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©";
		}

		async function captureAndDownload(data) {
			const cap = document.getElementById('receipt-capture');
			const now = new Date();
			const dateStr = now.toLocaleDateString('en-GB'); 
			const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });

			document.getElementById('cap-data').innerHTML = `
				<div class="flex justify-between border-b pb-2"><span>Ø§Ù„Ù„ÙˆØ­Ø©:</span><b>${data.plateNum}</b></div>
				<div class="flex justify-between border-b pb-2"><span>Ø§Ù„ÙƒØ±Øª:</span><b>#${data.cardNum}</b></div>
				<div class="flex justify-between border-b pb-2"><span>Ø§Ù„Ø®Ø¯Ù…Ø©:</span><b>${data.serviceType === 'Free' ? 'Ù…Ø¬Ø§Ù†ÙŠØ©' : 'Ù…Ø¯ÙÙˆØ¹Ø©'}</b></div>
				<div class="text-right mt-4 text-sm font-black uppercase">${dateStr} | ${timeStr}</div>
			`;
			
			// Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ù„ØªÙˆØ§ØµÙ„
			document.getElementById('cap-staff-name').innerText = currentUser.name;
			document.getElementById('cap-staff-phone').innerText = currentUser.phone || 'N/A';

			const canvas = await html2canvas(cap, { scale: 2, useCORS: true });
			const link = document.createElement('a');
			link.download = `Receipt-${data.plateNum}.png`;
			link.href = canvas.toDataURL();
			link.click();
		}

		async function loadReports() {
			const list = document.getElementById('reports-list');
			list.innerHTML = `<div class="text-center py-10 opacity-50 font-bold">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>`;
			try {
				const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'getReports' }) });
				const reports = await res.json();
				list.innerHTML = '';
				reports.forEach(r => {
					const isParked = r.vehicleStatus === 'Parked';
					// Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ± Ù…ØªØ§Ø­ Ù„Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¢Ù†
					list.innerHTML += `
						<div class="invoice-card shadow-sm border-r-4 ${isParked ? 'border-orange-400' : 'border-green-400'}">
							<div class="flex justify-between items-center mb-2">
								<span class="text-xl font-black text-[#632323]">${r.plateNum}</span>
								<span class="text-[10px] font-bold px-2 py-1 rounded bg-gray-100 uppercase">${isParked ? 'ğŸ…¿ï¸ ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹' : 'âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…'}</span>
							</div>
							<div class="text-[11px] opacity-60 mb-4 text-right">
								<p>Ø§Ù„Ø¹Ù…ÙŠÙ„: ${r.clientName} | ÙƒØ±Øª: #${r.cardNum}</p>
								<p>Ø§Ù„Ù…ÙˆØ¸Ù: ${r.valet}</p>
							</div>
							<div class="flex gap-2">
								<button onclick='rePrint(${JSON.stringify(r)})' class="flex-1 bg-gray-800 text-white py-2 rounded-lg text-[10px] font-bold active:scale-95">ØªØµØ¯ÙŠØ± Ø¥ÙŠØµØ§Ù„</button>
								${(isParked && currentUser.role !== 'Client') ? `<button onclick="outVehicle('${r.plateNum}', '${r.cardNum}')" class="flex-1 bg-green-600 text-white py-2 rounded-lg text-[10px] font-bold">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</button>` : ''}
							</div>
						</div>`;
				});
				lucide.createIcons();
			} catch(e) { list.innerHTML = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«"; }
		}

		function rePrint(data) {
			// Ù…Ù„Ø§Ø­Ø¸Ø©: rePrint ÙŠØ³ØªØ®Ø¯Ù… Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŒ ÙˆÙ„ÙƒÙ† Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„ Ø³ÙŠÙƒÙˆÙ† Ù„Ù„Ù…ÙˆØ¸Ù "Ø§Ù„Ø­Ø§Ù„ÙŠ" Ø§Ù„Ø°ÙŠ ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
			captureAndDownload({ 
				plateNum: data.plateNum, 
				cardNum: data.cardNum, 
				serviceType: data.status === 'Free' ? 'Free' : 'Paid'
			});
		}

		async function outVehicle(plate, card) {
			if(!confirm("Ù‡Ù„ Ø§Ø³ØªÙ„Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø©ØŸ")) return;
			await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'updateVehicleStatus', plateNum: plate, cardNum: card }) });
			loadReports();
		}

		async function loadAttendanceSystem() {
			const list = document.getElementById('attendance-list');
			list.innerHTML = `<div class="text-center py-10 opacity-50">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>`;
			try {
				const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'getEmployees' }) });
				const emps = await res.json();
				list.innerHTML = "";
				emps.forEach(emp => {
					list.innerHTML += `<div class="glass p-4 mb-3 border border-gray-100 shadow-sm"><div class="flex justify-between items-center mb-3"><span class="text-[10px] bg-[#632323]/10 text-[#632323] px-2 py-1 rounded font-bold">${emp.job}</span><div class="font-black text-[#632323]">${emp.name}</div></div><div class="flex gap-2"><select id="stat-${emp.name}" class="flex-1 p-3 bg-white rounded-xl text-[11px] font-bold"><option value="Present">Present</option><option value="Absent">Absent</option></select><input type="number" id="hrs-${emp.name}" value="8" class="w-14 p-3 bg-white rounded-xl text-center font-bold text-sm"><button onclick="confirmAtt('${emp.name}')" class="bg-[#632323] text-white px-4 rounded-xl text-[11px] font-black">Ø­ÙØ¸</button></div></div>`;
				});
			} catch(e) { list.innerHTML = "Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"; }
		}

		async function confirmAtt(name) {
			const data = { action: 'submitAttendance', employeeName: name, hours: document.getElementById(`hrs-${name}`).value, status: document.getElementById(`stat-${name}`).value, date: new Date().toLocaleDateString('en-CA'), submittedBy: currentUser.name };
			await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
			alert(`ØªÙ… ØªØ­Ø¶ÙŠØ± ${name}`);
		}

		function navTo(id) {
			document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
			document.querySelectorAll('nav button').forEach(b => b.classList.remove('nav-active'));
			document.getElementById(id).classList.add('active');
			document.getElementById('nav-'+id).classList.add('nav-active');
			if(id === 'reports') loadReports();
			if(id === 'attendance') loadAttendanceSystem();
		}

		lucide.createIcons();
	</script>
</body>
</html>
